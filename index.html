<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Crossword Puzzles</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* CSS Styles */

        body {
            color: #eae2b7;
            font-family: 'Roboto', sans-serif;
            background-color: #003049;
        }

        #main-container h1 {
            color: #d62828;
            font-family: 'Pacifico', cursive;
            font-size: 45px;
            margin-bottom: 0px;
        }

        footer {
            margin-top: 20px;
        }

        #crossword-grid table {
            border-collapse: collapse;
            margin: auto;
        }

        #crossword-grid td {
            border: 1px solid #f77f00;
            width: 30px;
            height: 30px;
            text-align: center;
            vertical-align: middle;
            position: relative;
        }

        .number-overlay {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 12px;
            color: #eae2b7;
        }

        #hints {
            margin-top: 20px;
            text-align: left;
            max-width: 400px;
            /* Adjust this value based on your crossword grid width */
            margin-left: auto;
            margin-right: auto;
            color: #a7c957;
        }

        #progress-key-grid div {
            display: inline-block;
            border: 1px solid #f77f00;
            width: 30px;
            height: 30px;
            text-align: center;
            vertical-align: middle;
            line-height: 30px;
            font-size: 20px;
            cursor: pointer;
        }

        #progress-message {
            margin-top: 10px;
            max-width: 300px;
            /* Same as hints */
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .popup {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .popup-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 300px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .congratulations-popup {
            background-color: #335c67;
            /* Semi-transparent blue */
            color: white;
            border: 2px solid #fff3b0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); */
        }

        h2,
        h3 {
            color: #fcbf49;
        }

        #instructions {
            text-align: justify;
            max-width: 500px;
            /* Adjust as per the width of your crossword grid */
            margin: auto;
        }

        #instructions ol {
            padding-left: 20px;
        }

        #instructions li {
            margin-bottom: 15px;
            font-size: 15px;
            /* Adjust font size as needed */
        }

        #known-bugs {
            text-align: justify;
            max-width: 500px;
            /* Adjust as per your preference */
            margin: auto;
        }

        #known-bugs ul {
            padding-left: 20px;
        }

        #known-bugs li {
            margin-bottom: 15px;
            font-size: 15px;
            /* Adjust font size as needed */
        }

        #signature {
            font-family: 'Pacifico', cursive;
            color: #a7c957;
            text-align: center;
            font-size: 18px;
            margin-top: 0px;
            margin-bottom: 50px;
        }

        .email-link {
            color: #fcbf49;
            /* Change to your desired color */
            text-decoration: none;
            /* Optional: Removes underline */
        }

        .email-link:hover {
            text-decoration: underline;
            /* Optional: Underline on hover */
        }

        #custom-footer {
            font-family: 'Roboto', sans-serif;
            color: #6a994e;
            /* Change the color code as you like */
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            /* background-color: #415a77; */
        }

        .orientation-color {
            color: #fcbf49;
            /* Replace with your desired color */
        }

        #special-note {
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            color: #94d2bd;
            /* Your preferred text color */
            text-align: justify;
            /* Justify the text */
            display: none;
            /* Initially hidden */
            /* Add any other styling as needed */
        }
    </style>
</head>

<body>
    <input type="text" id="hiddenInput"
        style="position: absolute; left: -9999px; top: -9999px; width: 1px; height: 1px; opacity: 0;">
    <div id="main-container" style="text-align: center;">
        <h1>Crossword Factory</h1>
        <div id="signature">
            Made by <a href="mailto:rayden@gmail.com" class="email-link">Chay</a> for Elise
        </div>
        <h2 id="puzzle-title"></h2>
        <div id="crossword-grid"><!-- Grid will be generated by JavaScript --></div>

        <h3>Puzzle Key</h3>
        <div id="progress-key-grid" style="display: inline-block;">
            <!-- Progress key cells will be generated here -->
        </div>
        <div id="progress-message"></div>
        <br>
        <h3>Hints</h3>
        <div id="hints">
            <!-- Hints will be listed here -->
        </div>
        <p><!-- Instructions go here --></p>
        <br>
        <div id="special-note">
            <strong>Hidden Secret:</strong> Within the cosmic tableau above, a hidden sequence lies in view,
            digits from the heavens, a celestial code just for you.
            Begin where light first dawns, and count the sphere or solution as it spawns,
            seek the digits they represent, a secret numeric string you will find.
            Not just in their names, but in their order of the dance,
            unlock the cosmic rhythm, and you might just have a chance.
            A praise like no other awaits thee, if you truly see the signs,
            decode this astral puzzle, where every star aligns.
        </div>
        <h3>How to play</h3>
        <div id="instructions">
            <ol>
                <li>Review the list of crossword hints above.</li>
                <li>Select a matching hint number on the crossword grid.</li>
                <li>The length of the word is auto highlighted in red.</li>
                <li>Start inputting letters to your answer.</li>
                <li>Answers are automatically checked as you type. Pretty cool, right?</li>
                <li>If the answer is correct, the word will be highlighted in green.</li>
                <li>If incorrect, the highlight remains red while selection is active.</li>
                <li>You can always return to a word and solve it by selecting its number.</li>
                <li>Ensure that you type the word in full even letter cross.</li>
                <li>Once all solved words turn green, you will be presented with a key.</li>
                <li>Store this key in a cool dry place. It is your key to the next puzzle.</li>
                <li>Enter your key in the Puzzle Key field to load your progress.</li>
                <li>If you're reminded of me while solving, you receive extra super powers</li>
            </ol>
        </div>
        <br>
        <h3>Troubleshooting</h3>
        <div id="known-bugs">
            <ul>
                <li>Crossword input starts at a random cell in middle of the highlighted cells or no letters appear for
                    a few key strokes. If this happens, please keep inputting test letters and the crossword grid will
                    correct itself. The character input will loop around to the starting cell. And you can input the
                    desired answer.</li>
                <li>If you select the Puzzle Key field to input a Puzzle Key but choose not to proceed. And return to
                    the crossword on display, your crossword input can temporarily mirror in the Puzzle Key field too.
                    This is will correct itself and shouldn't affect puzzle solving.</li>
                <li>In the unlikely event of water landing on your phone or computer, you can always reload the page,
                    enter the most recent most recent Puzzle Key you unlocked and continue your progress.</li>
                <li>For technical or comedic assistance, you may always contact me. I'd be delighted to hear from you.😊
                </li>
            </ul>
        </div>
    </div>
    <div id="congrats-popup" class="popup">
        <div class="popup-content">
            <span class="close-btn">&times;</span>
            <p id="congrats-message"></p>
        </div>
    </div>
    <footer id="custom-footer">
        Crossword Factory Version 1.0 made by Chay for Elise | © All Rights, Lefts, Round Abouts, Dinner and Brunch
        Tables Reserved.
    </footer>
    <script>

        var crosswordPuzzles = [
            {
                "title": "Puzzle 1/3: The Familiar Joys",
                "progressKey": "JOYS",
                "size": 12,
                "words": [
                    {
                        "hint": "A stream of sorts, where no fish swims, but laughter flows amidst familial whims. Not a place of nature\u2019s making, but a haven for those, their fortune forsaking.",
                        "answer": "SCHITTSCREEK",
                        "position": { "x": 0, "y": 5, "orientation": "horizontal" }
                    },
                    {
                        "hint": "In a world before our time, this caveman had his shine.",
                        "answer": "GRUG",
                        "position": { "x": 1, "y": 0, "orientation": "vertical" }
                    },
                    {
                        "hint": "The last name of a comedic doctor, whose blue antics are a shocker.",
                        "answer": "FUNKE",
                        "position": { "x": 0, "y": 2, "orientation": "horizontal" }
                    },
                    {
                        "hint": "A name shared by many, including a boy with tricks aplenty. In a tale of holiday cheer, his wit and courage made intruders steer clear.",
                        "answer": "KEVIN",
                        "position": { "x": 3, "y": 2, "orientation": "vertical" }
                    },
                    {
                        "hint": "A name shared by the beloved actor, who once played a 'Home Alone' crook, and a cup that starts your day with a look.",
                        "answer": "JOE",
                        "position": { "x": 4, "y": 0, "orientation": "vertical" }
                    },
                    {
                        "hint": "Straya's favourite delight, perfect for a midnight bite.",
                        "answer": "TIMTAM",
                        "position": { "x": 6, "y": 2, "orientation": "horizontal" }
                    },
                    {
                        "hint": "Her wigs are many, her drama plenty, once seen a rich freak, now lives down a creek. One may mistake her cast for another mother\u2019s past, yet this one didn\u2019t leave a child in the Big Apple\u2019s vast.",
                        "answer": "MOIRA",
                        "position": { "x": 8, "y": 2, "orientation": "vertical" }
                    },
                    {
                        "hint": "A dance of words, not feet, playful jabs that are intentionally sweet. A natural trait we both share, because as a pair of Leos, we truly care. In conversations, it's a spark, often followed by a charming remark.",
                        "answer": "BANTER",
                        "position": { "x": 10, "y": 1, "orientation": "vertical" }
                    },
                    {
                        "hint": "A word that could point to a star or reveal the first name of a sitcom's goofy neighbour.",
                        "answer": "COSMO",
                        "position": { "x": 1, "y": 5, "orientation": "vertical" }
                    },
                    {
                        "hint": "The name of a fluffy affectionate monochromatic cuddle bear like I, whose inner strengths were unlocked by wisdom and inspiration. Like you, he persevered against the challenges of lords and changed the prophecy's odds.",
                        "answer": "PO",
                        "position": { "x": 0, "y": 9, "orientation": "horizontal" }
                    },
                    {
                        "hint": "From space adventures to Strayan stick candy treats, the presence of this word could mean both techy or tasty.",
                        "answer": "MUSK",
                        "position": { "x": 1, "y": 8, "orientation": "horizontal" }
                    },
                    {
                        "hint": "Comedy on its feet, where laughs and anecdotes meet.",
                        "answer": "STANDUP",
                        "position": { "x": 6, "y": 5, "orientation": "vertical" }
                    }
                    // Add more words here as needed ...
                ]
            },
            {
                "title": "Puzzle 2/3: A Signal from the Stars",
                "progressKey": "STAR",
                "size": 14,
                "words": [
                    {
                        // Sun
                        "hint": "The cosmic maestro orchestrating daylight's symphony, where every planet dances to its radiant melody.",
                        "answer": "SUN",
                        "position": { "x": 3, "y": 5, "orientation": "horizontal" }
                    },
                    {
                        // Mars
                        "hint": "This red-faced planet might blush if it had water.",
                        "answer": "MARS",
                        "position": { "x": 3, "y": 2, "orientation": "vertical" }
                    },
                    {
                        // Venus
                        "hint": "Named after a goddess, but its hot temper is no myth.",
                        "answer": "VENUS",
                        "position": { "x": 2, "y": 9, "orientation": "horizontal" }
                    },
                    {
                        // Earth
                        "hint": "The only place in the cosmos known for coffee shops.",
                        "answer": "EARTH",
                        "position": { "x": 8, "y": 4, "orientation": "vertical" }
                    },
                    {
                        // Zero
                        "hint": "The number of dragons found in outter space.",
                        "answer": "ZERO",
                        "position": { "x": 4, "y": 11, "orientation": "horizontal" }
                    },
                    {
                        // Mercury
                        "hint": "Swiftly orbits the Sun, not just a thermometer ingredient.",
                        "answer": "MERCURY",
                        "position": { "x": 7, "y": 4, "orientation": "horizontal" }
                    },
                    {
                        // Neptune
                        "hint": "A windy giant, blue and far, named after the sea god.",
                        "answer": "NEPTUNE",
                        "position": { "x": 5, "y": 5, "orientation": "vertical" }
                    },
                    {
                        // One
                        "hint": "The number of lunar bodies that light up our night walks.",
                        "answer": "ONE",
                        "position": { "x": 3, "y": 7, "orientation": "vertical" }
                    },
                    {
                        // Pluto
                        "hint": "Once counted among the planets, now a dwarf, but still as lovable as a famous mouse's loyal canine mate.",
                        "answer": "PLUTO",
                        "position": { "x": 5, "y": 7, "orientation": "horizontal" }
                    },
                    {
                        // Four
                        "hint": "The Galilean count of lunar bodies orbiting a giant with great clout.",
                        "answer": "FOUR",
                        "position": { "x": 0, "y": 4, "orientation": "horizontal" }
                    }
                ]
            },
            {
                "title": "Puzzle 3/3: Sic Parvis Magna",
                "progressKey": "WISH",
                "size": 12,
                "words": [
                    {
                        "hint": "The one reading this, the one that radiates inspiration. The one that gives meaning to purpose.",
                        "answer": "YOU",
                        "position": { "x": 1, "y": 3, "orientation": "horizontal" }
                    },
                    {
                        "hint": "Late breakfast or early lunch? A delicious dilemma.",
                        "answer": "BRUNCH",
                        "position": { "x": 3, "y": 1, "orientation": "vertical" }
                    },
                    {
                        "hint": "Not alone, but accompanied, in company or in dish.",
                        "answer": "WITH",
                        "position": { "x": 0, "y": 6, "orientation": "horizontal" }
                    },
                    {
                        "hint": "A testament of intent, where desires and objectives are sown into the fabric of future plans. Often seen as a power that drives determination. A power that shines bright in you.",
                        "answer": "WILL",
                        "position": { "x": 1, "y": 5, "orientation": "vertical" }
                    },
                    {
                        "hint": "A magic word that opens many doors, not just in manners.",
                        "answer": "PLEASE",
                        "position": { "x": 0, "y": 8, "orientation": "horizontal" }
                    },
                    {
                        "hint": "An evening meal, sometimes a date, always a delight.",
                        "answer": "DINNER",
                        "position": { "x": 5, "y": 4, "orientation": "vertical" }
                    },
                    {
                        "hint": "A cuisine of pasta, pizza, and amore.",
                        "answer": "ITALIAN",
                        "position": { "x": 5, "y": 5, "orientation": "horizontal" }
                    },
                    {
                        "hint": "To possess, to hold, more than just in hands.",
                        "answer": "HAVE",
                        "position": { "x": 10, "y": 4, "orientation": "vertical" }
                    },
                    {
                        "hint": "The one asking, hoping for a yes. The ever optimistic and hopeful, hopeless romantic.",
                        "answer": "ME",
                        "position": { "x": 9, "y": 7, "orientation": "horizontal" }
                    }
                ]
            },
        ];

        var congratulatoryMessages = [
            "🎉 You're a champion, Elise! 🎉",
            "🌟 Bravo Elise! Onwards! 🌟",
            "💫 Genius! Keep soarin'. 💫"
            // Add more messages as desired
        ];

        // Declare global variables
        var highlightedCells = [];
        var wordPositions = {};
        var currentPuzzleIndex = 0;

        function areAllWordsCorrect() {
            return crosswordData.words.every(function (word, index) {
                var wordInfo = wordPositions[index + 1];
                for (var i = 0; i < wordInfo.length; i++) {
                    var cell = wordInfo.orientation === 'horizontal' ?
                        document.querySelector('#crossword-table').rows[wordInfo.y].cells[wordInfo.x + i] :
                        document.querySelector('#crossword-table').rows[wordInfo.y + i].cells[wordInfo.x];
                    if (cell.textContent.replace(/[0-9]/g, '').toUpperCase() !== word.answer[i].toUpperCase()) {
                        return false;
                    }
                }
                return true;
            });
        }

        function loadPuzzle(index) {
            // Clear existing crossword grid and hints
            document.getElementById('crossword-grid').innerHTML = '';
            document.getElementById('hints').innerHTML = '';

            if (index >= 0 && index < crosswordPuzzles.length) {
                crosswordData = crosswordPuzzles[index];
                document.getElementById('puzzle-title').textContent = crosswordData.title;
                renderCrossword();
                currentPuzzleIndex = index;
                // Optional: Update any UI elements with the new puzzle title
                // document.getElementById('puzzle-title').textContent = crosswordData.title;
            } else {
                // Handle the scenario where all puzzles are completed
                console.log("All puzzles completed!");
            }
            // Show the special note for Puzzle 1
            var specialNote = document.getElementById('special-note');
            if (index === 1) { // Assuming Puzzle 2 is at index 2 in your crosswordPuzzles array
                specialNote.style.display = 'block';
            } else {
                specialNote.style.display = 'none';
            }
        }

        // The Rendering of Crossword Puzzle
        function renderCrossword() {
            // Reset global variables
            highlightedCells = [];
            wordPositions = {};

            var grid = document.createElement('table');
            grid.id = 'crossword-table';

            for (var i = 0; i < crosswordData.size; i++) {
                var row = grid.insertRow();
                for (var j = 0; j < crosswordData.size; j++) {
                    var cell = row.insertCell();
                    // Initialize each cell as blank or with a placeholder
                    cell.textContent = ''; // or use '_' for a placeholder
                }
            }
            document.getElementById('crossword-grid').appendChild(grid);
            assignNumbersAndEventListeners(grid);
            renderHints();
        }

        function assignNumbersAndEventListeners(grid) {
            crosswordData.words.forEach(function (word, index) {
                var x = word.position.x;
                var y = word.position.y;
                wordPositions[index + 1] = { length: word.answer.length, orientation: word.position.orientation, x: x, y: y };
                var cell = grid.rows[y].cells[x];
                var numberOverlay = document.createElement('span');
                numberOverlay.className = 'number-overlay';
                numberOverlay.textContent = index + 1;
                cell.appendChild(numberOverlay);
            });

            var cells = document.querySelectorAll('#crossword-table td');
            cells.forEach(function (cell, index) {
                cell.addEventListener('click', function () {
                    clearSelection(cells);
                    var clickedNumber = parseInt(cell.querySelector('.number-overlay')?.textContent);
                    if (wordPositions[clickedNumber]) {
                        var wordInfo = wordPositions[clickedNumber];
                        highlightWord(grid, wordInfo.x, wordInfo.y, wordInfo.length, wordInfo.orientation);

                        // Set focus to hidden input
                        document.getElementById('hiddenInput').focus();
                    }
                });
                cell.addEventListener('touchend', function () {
                    document.getElementById('hiddenInput').focus();  // Add this for mobile compatibility
                });
            });
        }

        function clearSelection(cells) {
            cells.forEach(function (c) { c.style.backgroundColor = ''; });
        }

        function highlightWord(grid, startX, startY, length, orientation) {
            highlightedCells = [];
            for (var i = 0; i < length; i++) {
                var highlightCell;
                if (orientation === 'horizontal') {
                    highlightCell = grid.rows[startY].cells[startX + i];
                } else {
                    highlightCell = grid.rows[startY + i].cells[startX];
                }
                highlightCell.style.backgroundColor = '#9b2226'; // Crossword-Grid-Highlight-Red
                highlightedCells.push(highlightCell);
            }
        }

        function renderHints() {
            var hintList = document.getElementById('hints');
            var hintNumber = 1;
            crosswordData.words.forEach(function (word) {
                var orientation = word.position.orientation === 'horizontal' ? 'Horizontal' : 'Vertical';
                var hintPara = document.createElement('p');
                var orientationSpan = document.createElement('span');
                orientationSpan.className = 'orientation-color';
                orientationSpan.textContent = orientation;

                hintPara.textContent = hintNumber + '. ';
                hintPara.appendChild(orientationSpan);
                hintPara.appendChild(document.createTextNode(': ' + word.hint));
                hintList.appendChild(hintPara);
                hintNumber++;
            });
        }

        function setUpInputHandler() {
            var currentHighlightedCellIndex = 0;

            document.addEventListener('keypress', function (event) {
                console.log("Keypress detected:", event.key);
                var char = String.fromCharCode(event.keyCode).toUpperCase();
                if (/[a-zA-Z]/.test(char) && highlightedCells.length > 0) {
                    var targetCell = highlightedCells[currentHighlightedCellIndex];

                    if (targetCell) {
                        // Check if the cell contains a number overlay
                        var overlay = targetCell.querySelector('.number-overlay');
                        if (overlay) {
                            // Clear the cell if it's the first cell of a word
                            targetCell.innerHTML = '';
                            targetCell.appendChild(overlay);
                        }

                        // Update the cell with the typed character
                        targetCell.textContent = char;

                        // Re-insert the overlay if it exists
                        if (overlay) {
                            targetCell.insertBefore(overlay, targetCell.firstChild);
                        }

                        // Move to the next cell in the highlightedCells array
                        currentHighlightedCellIndex = (currentHighlightedCellIndex + 1) % highlightedCells.length;

                        // Check answer after the last character of the word is typed
                        if (currentHighlightedCellIndex === 0) {
                            // We have looped back to the start, meaning the end of the word was reached
                            var wordNumber = findWordNumber(highlightedCells[0]);
                            checkAnswer(wordNumber); // Call checkAnswer here
                        }
                    }
                }
            });
        }

        function checkProgressKey() {
            var enteredKey = '';
            var keyCells = document.querySelectorAll('#progress-key-grid div');
            keyCells.forEach(function (cell) {
                enteredKey += cell.textContent.toUpperCase();
                cell.textContent = ''; // Clear the cell after reading the value
                cell.style.backgroundColor = ''; // Reset background color
            });

            for (var i = 0; i < crosswordPuzzles.length; i++) {
                if (crosswordPuzzles[i].progressKey.toUpperCase() === enteredKey) {
                    loadPuzzle(i);
                    document.getElementById('progress-message').textContent = "Puzzle loaded successfully.";
                    return;
                }
            }
            document.getElementById('progress-message').textContent = "Invalid puzzle key.";
        }

        function findWordNumber(cell) {
            for (var number in wordPositions) {
                var wordInfo = wordPositions[number];
                if (cell.parentNode.rowIndex === wordInfo.y && cell.cellIndex === wordInfo.x) {
                    return number; // Return the word number
                }
            }
            return ""; // Return an empty string if no match is found
        }

        function checkAnswer(wordNumber) {
            console.log("checkAnswer called with wordNumber:", wordNumber);
            var wordInfo = wordPositions[wordNumber];
            var answer = crosswordData.words[wordNumber - 1].answer;
            var isCorrect = true;

            console.log('Checking answer for word number:', wordNumber);
            console.log('Expected answer:', answer);

            for (var i = 0; i < wordInfo.length; i++) {
                var cell;
                if (wordInfo.orientation === 'horizontal') {
                    cell = document.querySelector('#crossword-table').rows[wordInfo.y].cells[wordInfo.x + i];
                } else {
                    cell = document.querySelector('#crossword-table').rows[wordInfo.y + i].cells[wordInfo.x];
                }

                var cellLetter = cell.textContent.replace(/[0-9]/g, '').toUpperCase();
                console.log('Cell content:', cellLetter, 'Expected:', answer[i].toUpperCase());

                if (cellLetter !== answer[i].toUpperCase()) {
                    isCorrect = false;
                    break;
                }
            }

            console.log('Is correct:', isCorrect);

            if (isCorrect) {
                highlightedCells.forEach(function (cell) {
                    cell.style.backgroundColor = '#4f772d'; // Green
                });

                if (areAllWordsCorrect()) {
                    var nextPuzzleIndex = currentPuzzleIndex + 1;
                    var nextPuzzleKey = nextPuzzleIndex < crosswordPuzzles.length ? crosswordPuzzles[nextPuzzleIndex].progressKey : 'Completed all puzzles!';
                    var messageDuration = nextPuzzleIndex >= crosswordPuzzles.length ? 30 : 10; // 30 seconds for final message, 10 for others
                    var countdown = messageDuration;

                    var randomMessage = nextPuzzleIndex < crosswordPuzzles.length ? congratulatoryMessages[Math.floor(Math.random() * congratulatoryMessages.length)] + "<br>Puzzle Key Unlocked: " + nextPuzzleKey : null;

                    var countdownMessage = setInterval(function () {
                        if (countdown <= 0) {
                            clearInterval(countdownMessage);
                            if (nextPuzzleIndex < crosswordPuzzles.length) {
                                loadPuzzle(nextPuzzleIndex);
                            }
                        } else {
                            var message = nextPuzzleIndex >= crosswordPuzzles.length ? "✨🎉 Congratulations Elise! 🎉✨<br>🧩🏆 You're a master puzzle solver! A champion of champions! 🧩<br>🌟 Sic Parvis Magna: Great journeys have humble beginnings. 🌟<br> 🥂Here's hoping I may craft more smiles for you. 🫶 Keep on soaring! 🪁"
                                : randomMessage + "<br>Next puzzle will load in " + countdown + " seconds.";
                            showPopup(message);
                        }
                        countdown--;
                    }, 1000);
                }
            }
        }

        function submitProgressKey() {
            var enteredKey = '';
            var keyCells = document.querySelectorAll('#progress-key-grid div');
            keyCells.forEach(function (cell) {
                enteredKey += cell.textContent.toUpperCase();
            });

            for (var i = 0; i < crosswordPuzzles.length; i++) {
                if (crosswordPuzzles[i].progressKey.toUpperCase() === enteredKey) {
                    loadPuzzle(i);
                    document.getElementById('progress-message').textContent = "Puzzle loaded successfully.";
                    break; // Exit the loop as we found the matching key
                } else {
                    document.getElementById('progress-message').textContent = "Invalid progress key.";
                }
            }

            // Clear the cells after checking the key
            keyCells.forEach(function (cell) { cell.textContent = ''; });
        }

        // Global flag to track if the progress key grid is active
        var isProgressKeyActive = false;

        // Timer variable
        var progressKeyTimer;

        function handleProgressKeyInput(event) {
            if (!isProgressKeyActive) return; // Only proceed if the progress key grid is active

            // Reset the timer on each keypress
            clearTimeout(progressKeyTimer);
            startProgressKeyTimer();

            var keyCells = document.querySelectorAll('#progress-key-grid div');
            var activeCellIndex = keyCells.findIndex(cell => cell.style.backgroundColor === '#3c096c'); // Purple
            if (activeCellIndex !== -1 && /[a-zA-Z]/.test(event.key)) {
                keyCells[activeCellIndex].textContent = event.key.toUpperCase();
                var nextIndex = (activeCellIndex + 1) % keyCells.length;
                handleCellInput(nextIndex);
            }
        }

        function startProgressKeyTimer() {
            progressKeyTimer = setTimeout(function () {
                resetProgressKeyGrid();
            }, 2000); // 2 seconds
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Generate progress key cells
            var progressKeyGrid = document.getElementById('progress-key-grid');
            var keyCells = []; // Array to store the progress key cells

            for (var i = 0; i < 4; i++) {
                var cell = document.createElement('div');
                cell.style.cursor = 'pointer';
                cell.setAttribute('data-index', i); // Set a data attribute for indexing
                keyCells.push(cell); // Add cell to the array
                progressKeyGrid.appendChild(cell);
            }

            // Function to handle cell input
            function handleCellInput(index) {
                keyCells.forEach((cell, idx) => cell.style.backgroundColor = idx === index ? '#3c096c' : ''); // Purple

                document.addEventListener('keypress', function onKeypress(e) {
                    if (/[a-zA-Z]/.test(e.key)) {
                        keyCells[index].textContent = e.key.toUpperCase();
                        var nextIndex = (index + 1) % keyCells.length;
                        if (nextIndex === 0) {
                            // All cells are filled, submit the progress key
                            submitProgressKey();
                        } else {
                            // Move to the next cell for input
                            handleCellInput(nextIndex);
                        }
                    }
                    document.removeEventListener('keypress', onKeypress);
                }, { once: true });
            }

            keyCells.forEach(function (cell) {
                cell.addEventListener('click', function () {
                    var currentIndex = parseInt(this.getAttribute('data-index'));
                    handleCellInput(currentIndex);
                    isProgressKeyActive = true; // Set the flag when a cell is clicked
                    document.addEventListener('keypress', handleProgressKeyInput); // Ensure the listener is attached
                    startProgressKeyTimer(); // Start the timer


                    // Set focus to hidden input
                    document.getElementById('hiddenInput').focus();
                });

                cell.addEventListener('touchend', function () {
                    // Set focus to hidden input for mobile compatibility
                    var x = window.scrollX, y = window.scrollY; // Store current scroll position
                    document.getElementById('hiddenInput').focus(); // Set focus to hidden input
                    window.scrollTo(x, y); // Reset scroll position
                });
            });

            // Load the first puzzle and set up input handlers
            loadPuzzle(0);
            setUpInputHandler();
        });

        // Function to reset the progress key grid and remove the keypress listener
        function resetProgressKeyGrid() {
            var keyCells = document.querySelectorAll('#progress-key-grid div');
            keyCells.forEach(function (cell) {
                cell.textContent = '';
                cell.style.backgroundColor = '';
            });
            document.getElementById('progress-message').textContent = '';
            isProgressKeyActive = false; // Reset the flag when clicked outside
            clearTimeout(progressKeyTimer); // Clear the timer
            isProgressKeyActive = false;
            document.removeEventListener('keypress', handleProgressKeyInput); // Ensure the listener is detached
        }

        // Click event listener outside of the DOMContentLoaded
        document.addEventListener('click', function (event) {
            if (!document.getElementById('progress-key-grid').contains(event.target)) {
                resetProgressKeyGrid();
            }
        });

        // Add this at the end of your script, outside of any functions
        document.querySelector('.close-btn').addEventListener('click', function () {
            document.getElementById('congrats-popup').style.display = "none";
        });

        // Close the popup when clicking outside of it
        window.onclick = function (event) {
            var popup = document.getElementById('congrats-popup');
            if (event.target == popup) {
                popup.style.display = "none";
            }
        };

        function showPopup(message) {
            var popupContent = "<div class='congratulations-popup'>" + message + "</div>";
            var popupElement = document.createElement("div");
            popupElement.innerHTML = popupContent;
            document.body.appendChild(popupElement);

            // Automatically close the popup after 10 seconds
            setTimeout(function () {
                document.body.removeChild(popupElement);
            }, 10000);
        }
    </script>
</body>

</html>
